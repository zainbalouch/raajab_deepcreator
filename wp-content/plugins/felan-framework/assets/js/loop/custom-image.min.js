(function (o) {
  "use strict";
  var n = felan_custom_image_vars.ajax_url,
    t = felan_custom_image_vars.custom_image_title,
    c = felan_custom_image_vars.custom_image_type,
    r = felan_custom_image_vars.custom_image_file_size,
    l = felan_custom_image_vars.custom_image_text,
    u = felan_custom_image_vars.custom_image_upload_nonce;
  jQuery(document).ready(function () {
    var i = o(".felan-fields-custom_image");
    o.each(i, function () {
      var m = o(this).find("input.image-id").val();
      var i = function () {
        var e = new plupload.Uploader({
          browse_button: "felan_select_custom_image_" + m,
          file_data_name: "felan_custom_image_upload_file_" + m,
          drop_element: "felan_custom_image_view_" + m,
          container: "felan_custom_image_container_" + m,
          url:
            n +
            "?action=felan_custom_image_upload_ajax&nonce=" +
            u +
            "&custom_image_id=" +
            m,
          filters: {
            mime_types: [{ title: t, extensions: c }],
            max_file_size: r,
            prevent_duplicates: true,
          },
        });
        e.init();
        e.bind("UploadProgress", function (i, a) {
          document.getElementById("felan_select_custom_image_" + m).innerHTML =
            '<span><i class="fal fa-spinner fa-spin large"></i></span>';
        });
        e.bind("FilesAdded", function (i, a) {
          i.refresh();
          e.start();
        });
        e.bind("Error", function (i, a) {
          document.getElementById("felan_custom_image_errors_" + m).innerHTML +=
            "Error #" + a.code + ": " + a.message + "<br/>";
        });
        var i = o("#custom_image_id_" + m).val();
        var a = o("#custom_image_url_" + m).val();
        if (i && a) {
          var s =
            '<figure class="media-thumb media-thumb-wrap">' +
            '<img src="' +
            a +
            '">' +
            '<div class="media-item-actions">' +
            '<a class="icon icon-custom_image-delete_' +
            m +
            '" data-attachment-id="' +
            i +
            '" href="#" ><i class="far fa-trash-alt large"></i></a>' +
            '<span style="display: none;" class="icon icon-loader"><i class="fal fa-spinner fa-spin large"></i></span>' +
            "</div>" +
            "</figure>";
          o("#felan_custom_image_view_" + m).html(s);
          o("#felan_add_custom_image_" + m).hide();
        }
        e.bind("FileUploaded", function (i, a, e) {
          document.getElementById(
            "felan_drop_custom_image_" + m
          ).style.display = "none";
          var s = o.parseJSON(e.response);
          if (s.success) {
            o("#custom_image_url_" + m).val(s.full_image);
            o("#custom_image_id_" + m).val(s.attachment_id);
            var t =
              '<figure class="media-thumb media-thumb-wrap">' +
              '<img src="' +
              s.full_image +
              '">' +
              '<div class="media-item-actions">' +
              '<a class="icon icon-custom_image-delete_' +
              m +
              '" data-attachment-id="' +
              s.attachment_id +
              '" href="#" ><i class="far fa-trash-alt large"></i></a>' +
              '<span style="display: none;" class="icon icon-loader"><i class="fal fa-spinner fa-spin large"></i></span>' +
              "</div>" +
              "</figure>";
            o("#felan_custom_image_view_" + m).html(t);
            _();
            o("#custom_image_url-error_" + m).hide();
          }
        });
      };
      i();
      var _ = function (c) {
        o("body").on("click", ".icon-custom_image-delete_" + m, function (i) {
          i.preventDefault();
          var a = o(this),
            e = a,
            s = a
              .closest("#felan_custom_image_view_" + m)
              .find(".media-thumb-wrap"),
            t = a.data("attachment-id"),
            _ = o("#felan_drop_custom_image_" + m);
          e.html('<i class="fal fa-spinner fa-spin large"></i>');
          o.ajax({
            type: "post",
            url: n,
            dataType: "json",
            data: {
              action: "felan_custom_image_remove_ajax",
              attachment_id: t,
              type: c,
              removeNonce: u,
            },
            success: function (i) {
              if (i.success) {
                s.remove();
                s.hide();
                o("#custom_image_url-error_" + m).show();
                o("#felan_add_custom_image_" + m).show();
              }
              e.html('<i class="fal fa-spinner fa-spin large"></i>');
              _.css("display", "block");
              o("#felan_select_custom_image_" + m).html(l);
              o("input.custom_image_url_" + m).val("");
              o("input.custom_image_id_" + m).val("");
            },
            error: function () {
              e.html('<i class="far fa-trash-alt large"></i>');
            },
          });
        });
      };
      _();
    });
  });
})(jQuery);
