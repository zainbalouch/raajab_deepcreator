var GLF_MapClass=function(e){this.$container=e};(function(m){"use strict";GLF_MapClass.prototype={init:function(){this.$location=this.$container.find(".glf-map-location-field");this.$address=this.$container.find(".glf-map-address input");this.$findAddress=this.$container.find(".glf-map-address button");this.$maptype=this.$container.find(".glf-map-type").data("maptype");this.$mapstyle=this.$container.find(".glf-map-type").data("style");this.$mapapi=this.$container.find(".glf-map-type").data("api");this.$mapzoom=this.$container.find(".glf-map-type").data("zoom");if(this.$maptype=="google_map"){this.$canvas=this.$container.find(".glf-map-canvas");this.$googlemap_type=this.$container.find(".glf-map-type").data("googlemaptype");this.geocoder=new google.maps.Geocoder}else if(this.$maptype=="openstreetmap"){this.$canvas=this.$container.find(".glf-openstreetmap-canvas");this.geocoder=new google.maps.Geocoder}else{this.$mapbox=this.$container.find(".glf-mapbox-canvas")}this.bindMap();this.mapListener();this.findAddress();this.autoComplete()},bindMap:function(){var t=this;if(this.$maptype=="google_map"){var e=this.$location.val(),a=this.$canvas.data("options");e=e?e.split(","):[-33.868419,151.193245];var o=new google.maps.LatLng(e[0],e[1]);var n={center:o,zoom:this.$mapzoom,scrollwheel:false,streetViewControl:0,mapTypeId:this.$googlemap_type,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.HORIZONTAL_BAR,position:google.maps.ControlPosition.LEFT_BOTTOM}};if(a){n=m.extend(n,a)}this.map=new google.maps.Map(this.$canvas[0],n);this.marker=new google.maps.Marker({position:o,map:this.map,draggable:true})}else if(this.$maptype=="openstreetmap"){var e=t.$location.val(),a=t.$canvas.data("options");e=e?e.split(","):[-33.868419,151.193245];var o=new google.maps.LatLng(e[0],e[1]);t.mymap=L.map(t.$canvas[0],{zoomControl:false}).setView([e[0],e[1]],t.$mapzoom);var i="mapbox/"+t.$mapstyle;L.tileLayer("https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token="+t.$mapapi,{attribution:'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',id:i,tileSize:512,zoomOffset:-1,accessToken:t.$mapapi}).addTo(t.mymap);t.osm_marker=new L.marker([e[0],e[1]],{draggable:"true"});t.mymap.addLayer(t.osm_marker);var l=L.esri.Geocoding.geosearch().addTo(t.mymap);var r=L.layerGroup().addTo(t.mymap);l.on("results",function(e){r.clearLayers();for(var a=e.results.length-1;a>=0;a--){r.addLayer(t.osm_marker.setLatLng(new L.LatLng(e.results[a].latlng["lat"],e.results[a].latlng["lng"]),{draggable:"true"}));this.$location.val(e.results[a].latlng["lat"]+","+e.results[a].latlng["lng"])}})}else{var e=this.$location.val(),a=this.$mapbox.data("options");e=e?e.split(","):[-74.5,40];var n={center:[e[1],e[0]],zoom:16,scrollwheel:false,streetViewControl:0};if(a){n=m.extend(n,a)}mapboxgl.accessToken=this.$container.find(".glf-map-type").data("api");this.mapbox=new mapboxgl.Map({container:this.$mapbox[0],style:"mapbox://styles/mapbox/streets-v11",center:[e[1],e[0]],zoom:6});this.mapbox_marker=new mapboxgl.Marker({draggable:true}).setLngLat([e[1],e[0]]).addTo(this.mapbox);var s=new MapboxGeocoder({accessToken:mapboxgl.accessToken,mapboxgl:mapboxgl});s.on("result",function(e){m(".mapboxgl-marker").remove();t.$location.val(e.result.center[1]+","+e.result.center[0]);t.mapbox_marker=new mapboxgl.Marker({draggable:true}).setLngLat(e.result.center).addTo(t.mapbox);function a(){var e=t.mapbox_marker.getLngLat();t.mapbox_marker.setLngLat([e.lng,e.lat]);t.$location.val(e.lat+","+e.lng);t.changeField()}t.mapbox_marker.on("dragend",a)});this.mapbox.addControl(s)}},mapListener:function(){var t=this;if(this.$maptype=="google_map"){google.maps.event.addListener(t.map,"click",function(e){t.marker.setPosition(e.latLng);t.$location.val(e.latLng.lat()+","+e.latLng.lng());t.changeField()});google.maps.event.addListener(t.marker,"drag",function(e){t.$location.val(e.latLng.lat()+","+e.latLng.lng());t.changeField()})}else if(this.$maptype=="openstreetmap"){function e(){var e=t.osm_marker.getLatLng();t.$location.val(e.lat+","+e.lng);t.osm_marker.setLatLng(new L.LatLng(e.lat,e.lng),{draggable:"true"});t.mymap.panTo(new L.LatLng(e.lat,e.lng));t.changeField()}t.osm_marker.on("dragend",e);t.mymap.on("click",function(e){var a=t.osm_marker.getLatLng();t.$location.val(e.latlng.lat+","+e.latlng.lng);t.osm_marker.setLatLng(new L.LatLng(e.latlng.lat,e.latlng.lng),{draggable:"true"}).addTo(t.mymap);t.mymap.panTo(new L.LatLng(e.latlng.lat,e.latlng.lng));t.changeField()})}else{function e(){var e=t.mapbox_marker.getLngLat();t.mapbox_marker.setLngLat([e.lng,e.lat]);t.$location.val(e.lat+","+e.lng);t.changeField()}t.mapbox_marker.on("dragend",e);t.mapbox.on("click",function(e){var a=t.mapbox_marker.getLngLat();t.mapbox_marker.setLngLat(e.lngLat).addTo(t.mapbox);t.$location.val(a.lat+","+a.lng);t.changeField()})}},findAddress:function(){var o=this;if(this.$maptype=="google_map"){o.$findAddress.on("click",function(e){var a=o.$address.val();o.geocoder.geocode({address:a},function(e,a){if(a===google.maps.GeocoderStatus.OK){o.map.setCenter(e[0].geometry.location);o.marker.setPosition(e[0].geometry.location);o.$location.val(e[0].geometry.location.lat()+","+e[0].geometry.location.lng());o.changeField()}})})}else if(this.$maptype=="openstreetmap"){o.$findAddress.on("click",function(e){var a=o.$address.val();o.geocoder.geocode({address:a},function(e,a){if(a===google.maps.GeocoderStatus.OK){var t=o.osm_marker.getLatLng();o.$location.val(e[0].geometry.location.lat()+","+e[0].geometry.location.lng());o.osm_marker.setLatLng([e[0].geometry.location.lat(),e[0].geometry.location.lng()]).addTo(o.mymap);o.mymap.flyTo([e[0].geometry.location.lat(),e[0].geometry.location.lng()],this.$mapzoom,{animate:false,noMoveStart:true});o.changeField()}})})}else{o.$findAddress.on("click",function(e){var a=o.$address.val();o.geocoder.geocode({address:a},function(e,a){if(a===google.maps.GeocoderStatus.OK){var t=o.mapbox_marker.getLngLat();o.$location.val(e[0].geometry.location.lat()+","+e[0].geometry.location.lng());o.mapbox_marker.setLngLat([e[0].geometry.location.lng(),e[0].geometry.location.lat()]).addTo(o.mapbox);o.mapbox.flyTo({center:[e[0].geometry.location.lng(),e[0].geometry.location.lat()],essential:true});o.changeField()}})})}o.$address.on("keydown",function(e){if(e.which===13){e.preventDefault();o.$findAddress.trigger("click")}})},autoComplete:function(){var o=this;if(this.$maptype=="google_map"){o.$address.autocomplete({source:function(e,a){o.geocoder.geocode({address:e.term},function(e){a(m.map(e,function(e){return{label:e.formatted_address,value:e.formatted_address,latitude:e.geometry.location.lat(),longitude:e.geometry.location.lng()}}))})},select:function(e,a){var t=new google.maps.LatLng(a.item.latitude,a.item.longitude);o.map.setCenter(t);o.marker.setPosition(t);o.$location.val(a.item.latitude+","+a.item.longitude);o.changeField()}})}else if(this.$maptype=="openstreetmap"){o.$address.autocomplete({source:function(e,a){o.geocoder.geocode({address:e.term},function(e){a(m.map(e,function(e){return{label:e.formatted_address,value:e.formatted_address,latitude:e.geometry.location.lat(),longitude:e.geometry.location.lng()}}))})},select:function(e,a){var t=new google.maps.LatLng(a.item.latitude,a.item.longitude);o.$location.val(a.item.latitude+","+a.item.longitude);o.osm_marker.setLatLng([a.item.latitude,a.item.longitude]).addTo(o.mymap);o.mymap.flyTo([a.item.latitude,a.item.longitude],this.$mapzoom,{animate:false,noMoveStart:true});o.changeField()}})}else{o.$address.autocomplete({source:function(e,a){o.geocoder.geocode({address:e.term},function(e){a(m.map(e,function(e){return{label:e.formatted_address,value:e.formatted_address,latitude:e.geometry.location.lat(),longitude:e.geometry.location.lng()}}))})},select:function(e,a){var t=new google.maps.LatLng(a.item.latitude,a.item.longitude);o.$location.val(a.item.latitude+","+a.item.longitude);o.mapbox_marker.setLngLat([a.item.longitude,a.item.latitude]).addTo(o.mapbox);o.mapbox.flyTo({center:[a.item.longitude,a.item.latitude],essential:true});o.changeField()}})}},changeField:function(){var e=this.$container.closest(".glf-field"),a=GLFFieldsConfig.fields.getValue(e);GLFFieldsConfig.required.checkRequired(e,a)}};var e={init:function(){var e=m(".glf-meta-config-wrapper");e=e.length?e:m("body");e.on("glf_make_template_done",function(){m(".glf-field-map-inner").each(function(){var e=new GLF_MapClass(m(this));e.init()})});m(".glf-field.glf-field-map").on("glf_add_clone_field",function(e){var a=m(e.target).find(".glf-field-map-inner");if(a.length){var t=new GLF_MapClass(a);t.init()}})}};m(document).ready(function(){e.init();GLFFieldsConfig.fieldInstance.push(e);if(this.$maptype=="google_map"){m(".glf-tab a").on("glf-tab-clicked",function(e){var a=m(this).attr("href");m(".glf-map-canvas",a).each(function(){if(typeof google!="undefined"&&typeof google.maps!="undefined"&&typeof google.maps.event!="undefined"){google.maps.event.trigger(map,"resize")}})})}})})(jQuery);