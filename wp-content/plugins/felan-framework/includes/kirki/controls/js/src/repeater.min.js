var RepeaterRow=function(e,t,i,r){"use strict";var s=this;this.rowIndex=e;this.container=t;this.label=i;this.header=this.container.find(".repeater-row-header");this.header.on("click",function(){s.toggleMinimize()});this.container.on("click",".repeater-row-remove",function(){s.remove()});this.header.on("mousedown",function(){s.container.trigger("row:start-dragging")});this.container.on("keyup change","input, select, textarea",function(e){s.container.trigger("row:update",[s.rowIndex,jQuery(e.target).data("field"),e.target])});this.setRowIndex=function(e){this.rowIndex=e;this.container.attr("data-row",e);this.container.data("row",e);this.updateLabel()};this.toggleMinimize=function(){this.container.toggleClass("minimized");this.header.find(".dashicons").toggleClass("dashicons-arrow-up").toggleClass("dashicons-arrow-down")};this.remove=function(){this.container.slideUp(300,function(){jQuery(this).detach()});this.container.trigger("row:remove",[this.rowIndex])};this.updateLabel=function(){var e,t,i;if("field"===this.label.type){e=this.container.find('.repeater-field [data-field="'+this.label.field+'"]');if(_.isFunction(e.val)){t=e.val();if(""!==t){if(!_.isUndefined(r.params.fields[this.label.field])){if(!_.isUndefined(r.params.fields[this.label.field].type)){if("select"===r.params.fields[this.label.field].type){if(!_.isUndefined(r.params.fields[this.label.field].choices)&&!_.isUndefined(r.params.fields[this.label.field].choices[e.val()])){t=r.params.fields[this.label.field].choices[e.val()]}}else if("radio"===r.params.fields[this.label.field].type||"radio-image"===r.params.fields[this.label.field].type){i=r.selector+' [data-row="'+this.rowIndex+'"] .repeater-field [data-field="'+this.label.field+'"]:checked';t=jQuery(i).val()}}}this.header.find(".repeater-row-label").text(t);return}}}this.header.find(".repeater-row-label").text(this.label.value+" "+(this.rowIndex+1))};this.updateLabel()};wp.customize.controlConstructor.repeater=wp.customize.Control.extend({ready:function(){"use strict";var e=this;if(!_.isUndefined(window.kirkiControlLoader)&&_.isFunction(kirkiControlLoader)){kirkiControlLoader(e)}else{e.initKirkiControl()}},initKirkiControl:function(){"use strict";var r=this,t,i;var e=this.params.value;this.settingField=this.container.find("[data-customize-setting-link]").first();this.setValue([],false);this.repeaterFieldsContainer=this.container.find(".repeater-fields").first();this.currentIndex=0;this.rows=[];t=false;if(!_.isUndefined(this.params.choices.limit)){t=0>=this.params.choices.limit?false:parseInt(this.params.choices.limit,10)}this.container.on("click","button.repeater-add",function(e){e.preventDefault();if(!t||r.currentIndex<t){i=r.addRow();i.toggleMinimize();r.initColorPicker();r.initSelect(i)}else{jQuery(r.selector+" .limit").addClass("highlight")}});this.container.on("click",".repeater-row-remove",function(){r.currentIndex--;if(!t||r.currentIndex<t){jQuery(r.selector+" .limit").removeClass("highlight")}});this.container.on("click keypress",".repeater-field-image .upload-button,.repeater-field-cropped_image .upload-button,.repeater-field-upload .upload-button",function(e){e.preventDefault();r.$thisButton=jQuery(this);r.openFrame(e)});this.container.on("click keypress",".repeater-field-image .remove-button,.repeater-field-cropped_image .remove-button",function(e){e.preventDefault();r.$thisButton=jQuery(this);r.removeImage(e)});this.container.on("click keypress",".repeater-field-upload .remove-button",function(e){e.preventDefault();r.$thisButton=jQuery(this);r.removeFile(e)});this.repeaterTemplate=_.memoize(function(){var t,i={evaluate:/<#([\s\S]+?)#>/g,interpolate:/\{\{\{([\s\S]+?)\}\}\}/g,escape:/\{\{([^\}]+?)\}\}(?!\})/g,variable:"data"};return function(e){t=_.template(r.container.find(".customize-control-repeater-content").first().html(),null,i);return t(e)}});if(e.length){_.each(e,function(e){i=r.addRow(e);r.initColorPicker();r.initSelect(i,e)})}this.setValue(e,true,true);this.repeaterFieldsContainer.sortable({handle:".repeater-row-header",update:function(){r.sort()}})},openFrame:function(e){"use strict";if(wp.customize.utils.isKeydownButNotEnterEvent(e)){return}if(this.$thisButton.closest(".repeater-field").hasClass("repeater-field-cropped_image")){this.initCropperFrame()}else{this.initFrame()}this.frame.open()},initFrame:function(){"use strict";var e=this.getMimeType();this.frame=wp.media({states:[new wp.media.controller.Library({library:wp.media.query({type:e}),multiple:false,date:false})]});this.frame.on("select",this.onSelect,this)},initCropperFrame:function(){"use strict";var t=this.$thisButton.siblings("input.hidden-field").attr("data-field"),e=["width","height","flex_width","flex_height"],i=this.getMimeType();if(_.isString(t)&&""!==t){if(_.isObject(this.params.fields[t])&&"cropped_image"===this.params.fields[t].type){e.forEach(function(e){if(!_.isUndefined(this.params.fields[t][e])){this.params[e]=this.params.fields[t][e]}}.bind(this))}}this.frame=wp.media({button:{text:"Select and Crop",close:false},states:[new wp.media.controller.Library({library:wp.media.query({type:i}),multiple:false,date:false,suggestedWidth:this.params.width,suggestedHeight:this.params.height}),new wp.media.controller.CustomizeImageCropper({imgSelectOptions:this.calculateImageSelectOptions,control:this})]});this.frame.on("select",this.onSelectForCrop,this);this.frame.on("cropped",this.onCropped,this);this.frame.on("skippedcrop",this.onSkippedCrop,this)},onSelect:function(){"use strict";var e=this.frame.state().get("selection").first().toJSON();if(this.$thisButton.closest(".repeater-field").hasClass("repeater-field-upload")){this.setFileInRepeaterField(e)}else{this.setImageInRepeaterField(e)}},onSelectForCrop:function(){"use strict";var e=this.frame.state().get("selection").first().toJSON();if(this.params.width===e.width&&this.params.height===e.height&&!this.params.flex_width&&!this.params.flex_height){this.setImageInRepeaterField(e)}else{this.frame.setState("cropper")}},onCropped:function(e){"use strict";this.setImageInRepeaterField(e)},calculateImageSelectOptions:function(e,t){"use strict";var i=t.get("control"),r=!!parseInt(i.params.flex_width,10),s=!!parseInt(i.params.flex_height,10),a=e.get("width"),n=e.get("height"),o=parseInt(i.params.width,10),l=parseInt(i.params.height,10),d=o/l,h=a,f=n,u,c,p;t.set("canSkipCrop",!i.mustBeCropped(r,s,o,l,a,n));if(h/f>d){l=f;o=l*d}else{o=h;l=o/d}u=(h-o)/2;c=(f-l)/2;p={handles:true,keys:true,instance:true,persistent:true,imageWidth:a,imageHeight:n,x1:u,y1:c,x2:o+u,y2:l+c};if(false===s&&false===r){p.aspectRatio=o+":"+l}if(false===s){p.maxHeight=l}if(false===r){p.maxWidth=o}return p},mustBeCropped:function(e,t,i,r,s,a){"use strict";if(true===e&&true===t||true===e&&r===a||true===t&&i===s||i===s&&r===a||s<=i){return false}return true},onSkippedCrop:function(){"use strict";var e=this.frame.state().get("selection").first().toJSON();this.setImageInRepeaterField(e)},setImageInRepeaterField:function(e){"use strict";var t=this.$thisButton.closest(".repeater-field-image,.repeater-field-cropped_image");t.find(".kirki-image-attachment").html('<img src="'+e.url+'">').hide().slideDown("slow");t.find(".hidden-field").val(e.id);this.$thisButton.text(this.$thisButton.data("alt-label"));t.find(".remove-button").show();t.find("input, textarea, select").trigger("change");this.frame.close()},setFileInRepeaterField:function(e){"use strict";var t=this.$thisButton.closest(".repeater-field-upload");t.find(".kirki-file-attachment").html('<span class="file"><span class="dashicons dashicons-media-default"></span> '+e.filename+"</span>").hide().slideDown("slow");t.find(".hidden-field").val(e.id);this.$thisButton.text(this.$thisButton.data("alt-label"));t.find(".upload-button").show();t.find(".remove-button").show();t.find("input, textarea, select").trigger("change");this.frame.close()},getMimeType:function(){"use strict";var e=this.$thisButton.siblings("input.hidden-field").attr("data-field");if(_.isString(e)&&""!==e){if(_.isObject(this.params.fields[e])&&"upload"===this.params.fields[e].type){if(!_.isUndefined(this.params.fields[e].mime_type)){return this.params.fields[e].mime_type}}}return"image"},removeImage:function(e){"use strict";var t,i;if(wp.customize.utils.isKeydownButNotEnterEvent(e)){return}t=this.$thisButton.closest(".repeater-field-image,.repeater-field-cropped_image,.repeater-field-upload");i=t.find(".upload-button");t.find(".kirki-image-attachment").slideUp("fast",function(){jQuery(this).show().html(jQuery(this).data("placeholder"))});t.find(".hidden-field").val("");i.text(i.data("label"));this.$thisButton.hide();t.find("input, textarea, select").trigger("change")},removeFile:function(e){"use strict";var t,i;if(wp.customize.utils.isKeydownButNotEnterEvent(e)){return}t=this.$thisButton.closest(".repeater-field-upload");i=t.find(".upload-button");t.find(".kirki-file-attachment").slideUp("fast",function(){jQuery(this).show().html(jQuery(this).data("placeholder"))});t.find(".hidden-field").val("");i.text(i.data("label"));this.$thisButton.hide();t.find("input, textarea, select").trigger("change")},getValue:function(){"use strict";return JSON.parse(decodeURI(this.setting.get()))},setValue:function(e,t,i){"use strict";var s=e,a=[];if(i){jQuery.each(this.params.fields,function(e,t){if("image"===t.type||"cropped_image"===t.type||"upload"===t.type){a.push(e)}});jQuery.each(e,function(i,r){jQuery.each(a,function(e,t){if(!_.isUndefined(r[t])&&!_.isUndefined(r[t].id)){s[i][t]=r[t].id}})})}this.setting.set(encodeURI(JSON.stringify(s)));if(t){this.settingField.trigger("change")}},addRow:function(e){"use strict";var s=this,t=s.repeaterTemplate(),i=this.getValue(),r={},a,n,o;if(t){a=jQuery.extend(true,{},s.params.fields);if(e){for(o in e){if(e.hasOwnProperty(o)&&a.hasOwnProperty(o)){a[o].default=e[o]}}}a.index=this.currentIndex;t=t(a);n=new RepeaterRow(s.currentIndex,jQuery(t).appendTo(s.repeaterFieldsContainer),s.params.row_label,s);n.container.on("row:remove",function(e,t){s.deleteRow(t)});n.container.on("row:update",function(e,t,i,r){s.updateField.call(s,e,t,i,r);n.updateLabel()});this.rows[this.currentIndex]=n;for(o in a){if(a.hasOwnProperty(o)){r[o]=a[o].default}}i[this.currentIndex]=r;this.setValue(i,true);this.currentIndex++;return n}},sort:function(){"use strict";var i=this,e=this.repeaterFieldsContainer.find(".repeater-row"),r=[],s=i.getValue(),a=[],n=[];e.each(function(e,t){r.push(jQuery(t).data("row"))});jQuery.each(r,function(e,t){a[e]=i.rows[t];a[e].setRowIndex(e);n[e]=s[t]});i.rows=a;i.setValue(n)},deleteRow:function(e){"use strict";var t=this.getValue(),i,r,s;if(t[e]){i=this.rows[e];if(i){delete t[e];delete this.rows[e];this.setValue(t,true)}}r=1;for(s in this.rows){if(this.rows.hasOwnProperty(s)&&this.rows[s]){this.rows[s].updateLabel();r++}}},updateField:function(e,t,i,r){"use strict";var s,a,n;if(!this.rows[t]){return}if(!this.params.fields[i]){return}s=this.params.fields[i].type;a=this.rows[t];n=this.getValue();r=jQuery(r);if(_.isUndefined(n[a.rowIndex][i])){return}if("checkbox"===s){n[a.rowIndex][i]=r.is(":checked")}else{n[a.rowIndex][i]=r.val()}this.setValue(n,true)},initColorPicker:function(){"use strict";var n=this,e=n.container.find(".color-picker-hex"),t={},i=e.data("field");if(!_.isUndefined(i)&&!_.isUndefined(n.params.fields[i])&&!_.isUndefined(n.params.fields[i].palettes)&&_.isObject(n.params.fields[i].palettes)){t.palettes=n.params.fields[i].palettes}t.change=function(e,t){var i=jQuery(e.target),r=i.closest(".repeater-row"),s=r.data("row"),a=n.getValue();a[s][i.data("field")]=t.color.toString();n.setValue(a,true)};if(0!==e.length){e.wpColorPicker(t)}},initSelect:function(e,t){"use strict";var a=this,i=e.container.find(".repeater-field select"),r,s,n,o={};if(0===i.length){return}s=i.data("field");n=jQuery(i).data("multiple");if("undefed"!==n&&jQuery.isNumeric(n)){n=parseInt(n,10);if(1<n){o.maximumSelectionLength=n}}t=t||{};t[s]=t[s]||"";r=jQuery(i).selectWoo(o).val(t[s]||jQuery(i).val());this.container.on("change",".repeater-field select",function(e){var t=jQuery(e.target),i=t.closest(".repeater-row"),r=i.data("row"),s=a.getValue();s[r][t.data("field")]=jQuery(this).val();a.setValue(s)})}});