goog.provide("webfont.FontWatchRunner");goog.require("webfont.Font");goog.require("webfont.FontRuler");webfont.FontWatchRunner=function(t,s,e,o,i,n,r){this.activeCallback_=t;this.inactiveCallback_=s;this.domHelper_=e;this.font_=o;this.fontTestString_=r||webfont.FontWatchRunner.DEFAULT_TEST_STRING;this.lastResortWidths_={};this.timeout_=i||3e3;this.metricCompatibleFonts_=n||null;this.fontRulerA_=null;this.fontRulerB_=null;this.lastResortRulerA_=null;this.lastResortRulerB_=null;this.setupRulers_()};webfont.FontWatchRunner.LastResortFonts={SERIF:"serif",SANS_SERIF:"sans-serif"};webfont.FontWatchRunner.DEFAULT_TEST_STRING="BESbswy";goog.scope(function(){var o=webfont.FontWatchRunner,t=webfont.Font,s=webfont.FontRuler;o.HAS_WEBKIT_FALLBACK_BUG=null;o.getUserAgent=function(){return window.navigator.userAgent};o.hasWebKitFallbackBug=function(){if(o.HAS_WEBKIT_FALLBACK_BUG===null){var t=/AppleWebKit\/([0-9]+)(?:\.([0-9]+))/.exec(o.getUserAgent());o.HAS_WEBKIT_FALLBACK_BUG=!!t&&(parseInt(t[1],10)<536||parseInt(t[1],10)===536&&parseInt(t[2],10)<=11)}return o.HAS_WEBKIT_FALLBACK_BUG};o.prototype.setupRulers_=function(){this.fontRulerA_=new s(this.domHelper_,this.fontTestString_);this.fontRulerB_=new s(this.domHelper_,this.fontTestString_);this.lastResortRulerA_=new s(this.domHelper_,this.fontTestString_);this.lastResortRulerB_=new s(this.domHelper_,this.fontTestString_);this.fontRulerA_.setFont(new t(this.font_.getName()+","+o.LastResortFonts.SERIF,this.font_.getVariation()));this.fontRulerB_.setFont(new t(this.font_.getName()+","+o.LastResortFonts.SANS_SERIF,this.font_.getVariation()));this.lastResortRulerA_.setFont(new t(o.LastResortFonts.SERIF,this.font_.getVariation()));this.lastResortRulerB_.setFont(new t(o.LastResortFonts.SANS_SERIF,this.font_.getVariation()));this.fontRulerA_.insert();this.fontRulerB_.insert();this.lastResortRulerA_.insert();this.lastResortRulerB_.insert()};o.prototype.start=function(){this.lastResortWidths_[o.LastResortFonts.SERIF]=this.lastResortRulerA_.getWidth();this.lastResortWidths_[o.LastResortFonts.SANS_SERIF]=this.lastResortRulerB_.getWidth();this.started_=goog.now();this.check_()};o.prototype.widthMatches_=function(t,s){return t===this.lastResortWidths_[s]};o.prototype.widthsMatchLastResortWidths_=function(t,s){for(var e in o.LastResortFonts){if(o.LastResortFonts.hasOwnProperty(e)){if(this.widthMatches_(t,o.LastResortFonts[e])&&this.widthMatches_(s,o.LastResortFonts[e])){return true}}}return false};o.prototype.hasTimedOut_=function(){return goog.now()-this.started_>=this.timeout_};o.prototype.isFallbackFont_=function(t,s){return this.widthMatches_(t,o.LastResortFonts.SERIF)&&this.widthMatches_(s,o.LastResortFonts.SANS_SERIF)};o.prototype.isLastResortFont_=function(t,s){return o.hasWebKitFallbackBug()&&this.widthsMatchLastResortWidths_(t,s)};o.prototype.isMetricCompatibleFont_=function(){return this.metricCompatibleFonts_===null||this.metricCompatibleFonts_.hasOwnProperty(this.font_.getName())};o.prototype.check_=function(){var t=this.fontRulerA_.getWidth();var s=this.fontRulerB_.getWidth();if(this.isFallbackFont_(t,s)||this.isLastResortFont_(t,s)){if(this.hasTimedOut_()){if(this.isLastResortFont_(t,s)&&this.isMetricCompatibleFont_()){this.finish_(this.activeCallback_)}else{this.finish_(this.inactiveCallback_)}}else{this.asyncCheck_()}}else{this.finish_(this.activeCallback_)}};o.prototype.asyncCheck_=function(){setTimeout(goog.bind(function(){this.check_()},this),50)};o.prototype.finish_=function(t){setTimeout(goog.bind(function(){this.fontRulerA_.remove();this.fontRulerB_.remove();this.lastResortRulerA_.remove();this.lastResortRulerB_.remove();t(this.font_)},this),0)}});